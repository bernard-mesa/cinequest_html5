<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Cinequest</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/> 
<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css" />			
<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
<script src="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"></script>
<script>
var cnt = 0
var ProgramItemArray = [];
var FilmArray = [];
var SPGroupContainer = {
    hash: [],
    keys: [],
    length: 0,
    get: function(key){
    	return this.hash[key];
    },
    put: function(key, value){
    	this.hash[key] = value;
    	this.keys.push(key);
    	this.length++;
    }
}
var SPGroup = [];
var VenueArray = [];
$(document).ready(function () {

	
    $.ajax({
        type: "GET",
        url: "newcinequest.xml",
        dataType: "xml",
        success: function(xml) {
            $(xml).find('Show').each(function(){
				var pi = new Object();
				var fi = new Object();
				fi.properties = [];
				fi.schedules = [];
				fi.cast = '';
				fi.director = '';
				fi.genre = '';
				fi.producer = '';
				fi.writer = '';
				fi.editor = '';
				fi.cinematographer = '';
				fi.country = '';
				fi.languages = '';
				pi.films = [];
                pi.id = $(this).find('ID')[0].textContent;
                fi.id = pi.id;
				pi.name = $(this).find('Name')[0].textContent;
				fi.name = pi.name;
				pi.dura = $(this).find('Duration')[0].textContent;
				fi.dura = pi.dura;
				pi.descript = $(this).find('ShortDescription').text();
				fi.descript = pi.descript;
				pi.imgLink = $(this).find('EventImage').text();
				fi.imgLink = pi.imgLink;
				pi.infoLink = $(this).find('InfoLink').text();
				fi.infoLink = pi.infoLink;
				$customProperties = $(this).find('CustomProperties').find('CustomProperty');
				$customProperties.each(function(){
					var key = $(this).find('Name').text();
					var value = $(this).find('Value').text();
					if(key == 'Cast') fi.cast += value + ', ';
					if(key == 'Director') fi.director += value + ', ';
					if(key == 'Editor') fi.editor += value + ', ';
					if(key == 'Cinematographer') fi.cinematographer += value + ', ';
					if(key == 'Screenwriter') fi.writer += value + ', ';
					if(key == 'Genre') fi.genre += value + ', ';
					if(key == 'Producer') fi.producer += value + ', ';
					if(key == 'Country') fi.country += value + ', ';
					if(key == 'Language') fi.languages += value + ', '; 
				});
				$currentShowings = $(this).find('CurrentShowings').find('Showing');
				$currentShowings.each(function(){
					var show = new Object();
					show.id = $(this).find('ID').text();
					show.start = $(this).find('StartDate').text();
					show.end = $(this).find('EndDate').text();
					show.duration = $(this).find('Duration').text();
					$venue = $(this).find('Venue');
					show.venue = new Object();
					show.venue.id = $venue.find('VenueID').text();
					show.venue.name = $venue.find('VenueName').text();
					show.venue.address = $venue.find('VenueAddress1').text();
					fi.schedules.push(show);
				});
				
				if (fi.schedules.length > 0){
					if (pi.descript.indexOf("Shorts Program") < 0){
						pi.films.push(fi);
					}
					if(pi.name.indexOf("Shorts Program")!=0){
						ProgramItemArray.push(pi);
					}else{
						SPGroupContainer.put(pi.name.substring(0,16),pi)
					}
				}else{
					if(pi.descript.indexOf("Part of Shorts Program")==0){
						var key = pi.descript.substring(8,24);
					}else if(pi.descript.indexOf("Plays with")==0){
						var key = pi.descript.split('.')[0].substring(28);
					}else if(pi.descript.indexOf("Plays before")==0){
						var key = pi.descript.split('.')[0].substring(30);
					}
					SPGroup.push([key,fi]);
				}
				FilmArray.push(fi);
				
            });
			
			//at this point, the XML file has finished reading, begin manipulation here
		
			$.each(SPGroup,function(){
				var piKey = this[0];
				if(piKey != null){
					if(SPGroupContainer.get(piKey)!=null){
						SPGroupContainer.get(piKey).films.push(this[1]);
					}else{
						for(var i=0; i<ProgramItemArray.length; i++){
							if(ProgramItemArray[i].name==piKey){
								ProgramItemArray[i].films.push(this[1]);
							}
						}
					}
				}
			});
			
			$.each(SPGroupContainer.keys,function(){
				ProgramItemArray.push(SPGroupContainer.get(this));
			})
			console.log(ProgramItemArray.length)
			printFilmItem(ProgramItemArray);
        }   
    }); 
});

// print name of FilmArray or ProgramItemArry
function printFilmItem(col){
	$.each(col,function(){
		console.log(this.name);
	})
}

function getFilmInfo(fi){
	var info = "Film Title: " + fi.name + '\n';
	info += "Duration: " + fi.dura + '\n';
	info += "Description: " + fi.descript + '\n';
	info += "Link: " + fi.infoLink + '\n';
	info += "Image: " + fi.imgLink;
	return info;
}

function getProgramItemInfo(pi){
	var info = "Name: " + pi.name + '\n';
	info += "Description: " + pi.descript;
	return info;
}

// get film properties
function getFilmProperties(fi){
	var info = getSingleInfo(fi.cast,'Cast: ');
	info += getSingleInfo(fi.genre,'Genre: ');
	info += getSingleInfo(fi.producer,'Producer: ');
	info += getSingleInfo(fi.director,'Director: ');
	info += getSingleInfo(fi.country,'Country: ');
	info += getSingleInfo(fi.languages,'Language: ');
	info += getSingleInfo(fi.writer,'Writer: ');
	info += getSingleInfo(fi.cinematographer,'Cinematographer: ');
	info += getSingleInfo(fi.editor,'Editor: ');
	return info;
}

function getSingleInfo(prop,pNmae){
	if(prop.length > 0) return pNmae + prop.substring(0,prop.length-2) + '\n';
	else return '';
}

</script>
</head>
<body>
<p id="someElement"></p>
<p id="anotherElement"></p>

</body>
</html>